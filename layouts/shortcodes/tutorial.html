<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<style>
    #stage {
        display: none;
    }

    #stage-buttons-div {
        display:block;
        overflow:auto;
        padding-bottom: 30px;
        opacity:0;
    }

    #stage-button {
        float:left;
        padding-right:30px;
    }

    #content {
        display:block;
        position:relative;
        overflow:hidden;
        min-height: 500px;
        max-height:500px;
        opacity:0;
        
        border-radius:25px;
        border:2px solid;
    }

    #d1 {
        width:45%;
        height:100%;
        position: relative;
        padding: 5px 10px 5px 10px;
        float:left;
        opacity: inherit;

        border-radius:25px;
        border:2px solid;
    }

    #d2 {
        width:45%;
        height:100%;
        position:relative;
        padding: 5px 10px 5px 10px;
        float:right;
        opacity: inherit;

        border-radius:25px;
        border:2px solid;
    }

    #d3 {
        clear:both;
        width:100%;
        height:30%;
        position:absolute;
        bottom:0;
        padding: 5px 10px 5px 10px;
        opacity: inherit;

        border-radius:25px;
        border:2px solid;
        float:bottom;
    }

    .row {
        clear: both;
        align-items: stretch;
        margin: auto;

        width: 100%;
        height: 70%;
        position: absolute;
        padding: 5px 5px 5px 5px;
        opacity: inherit;

        border-radius:25px;
        border:2px solid;
        float: top;
    }
</style>

<body>
    <div id="stage">0</div>

    <div id="stage-buttons-div">
        <div class="column" id="stage-button">
            <input id="backbtn" type="button" value="BACK">
        </div>
        <div class="column" id="stage-button" style=>
            <input id="nextbtn" type="button" value="NEXT">
        </div>
    </div>

    <div id="content">
        <div class="row">
            <div class="column" id="d1"></div>
            <div class="column" id="d2"></div>
        </div>
        
        <div id="d3"></div>
    </div>
</body>

<script>
    var prev_stage = {};
    var curr_stage = {};
    var metadata = {};
    var stages = [];

    function readTextFile(file, callback) {
        var rawFile = new XMLHttpRequest();
        rawFile.overrideMimeType("application/json");
        rawFile.open("GET", file, true);
        rawFile.onreadystatechange = function () {
            if (rawFile.readyState === 4 && rawFile.status == "200") {
                callback(rawFile.responseText);
            }
        }
        rawFile.send(null);
    }

    function fadeDiv(id, in_or_out="in") {
        /*
        Call at the beginning of the transition.
        Fades out all content divs so they can later be
        populated with new content and then faded back in.
        */
        if (in_or_out == "in") {
            $(id).delay(500).animate({"opacity": "1"}, 1000);
        } else {
            $(id).delay(500).animate({"opacity": "0"}, 1000);
        }
        
    }

    function fillContentDiv(div, prev, curr) {
        var type = curr['type'];
        switch(type) {
            case 'text':
                div.innerHTML = curr['content'].join('<br><br>');
                break;
            case 'plot':
            case 'image':
                div.innerHTML = "<img src=" + curr['img']['path'] + " />"
        }
    }

    function fillContentAll() {
        // fill each of the three divs
        for (const x of Array(3).keys()) {
            // TODO add transitions
            
            // into to string to join with div
            var s = concat("d", toString(x));
            var div = document.getElementById(s);

            var prev = prev_stage[x];
            var curr = curr_stage[x];

            fillContentDiv(div, prev, curr);
        }
    }

    function transitionStage(in_or_out) {
        /*
        Takes in stage and an enum saying whether content
        is faded in or out.
        Specific divs can have a "fade" property (default to true)
        which can be set if the div should remain static.
        */
        for (const x of Array(3).keys()) {
            d = curr_stage[x];
            if (('fade' in d['formath']) && d['format']['fade'] == false) {
                continue;
            }
            var id = concat("#d", toString(x));
            fadeDiv(id, in_or_out);
        }
    }

    function updateStages(status) {
        /*
        Args: 
            status:      enum, [next / prev]

        Returns:
            nil, updates globals
        */

        var prev_stage_idx = parseInt(document.getElementById('stage').innerHTML);
        switch(status) {
            case 'next':
                var curr_stage_idx = prev_stage_idx + 1
                break;
            case 'prev':
                if (prev_stage_idx == 0) {
                    break;
                }
                var curr_stage_idx = prev_stage_idx - 1;
                break;
        }
        document.getElementById('stage').innerHTML = curr_stage_idx;
        curr_stage = stages[curr_stage_idx];
        prev_stage = stages[prev_stage_idx];   
    }

    function onUpdate(status) {
        /*
        Called on next or prev press. Updates the stage value, then calls cascading
        functions to update the page content.
        */

        updateStages(status);
        console.log(curr_stage)
        
        // fade out content
        transitionStage("out");

        // update content
        fillContentAll();

        // fade in content
        transitionStage("in");
    }

    function onNext() {
        console.log("next");
        onUpdate("next");
    }

    function onPrev() {
        console.log("prev");
        onUpdate("prev");
    }

    document.getElementById('nextbtn').addEventListener("click", onNext);

    document.getElementById('backbtn').addEventListener("click", onPrev);


    function main() {
        console.log("main");
        fadeDiv("#stage-buttons-div");
        fadeDiv("#content");
    }

    main();
</script>